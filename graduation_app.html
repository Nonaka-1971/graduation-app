<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å’æ¥­ãŠã‚ã§ã¨ã†ã‚¢ãƒ—ãƒª</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Meiryo', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .card {
      background: #fff;
      border-radius: 24px;
      padding: 36px 32px;
      max-width: 460px;
      width: 100%;
      box-shadow: 0 24px 64px rgba(0,0,0,0.25);
    }

    h1 { text-align: center; color: #333; font-size: 1.5em; margin-bottom: 22px; }

    label { display: block; margin-bottom: 6px; color: #555; font-weight: 600; font-size: 0.9em; }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1em;
      outline: none;
      -webkit-appearance: none;
    }

    input:focus { border-color: #667eea; }
    .form-group { margin-bottom: 16px; }
    .hint { margin-top: 5px; font-size: 0.78em; color: #aaa; }

    .btn {
      display: block;
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
      user-select: none;
    }

    .btn:active { opacity: 0.75; }

    #qr-section { margin-top: 22px; text-align: center; display: none; }
    #qr-image { display: inline-block; }
    #qr-image img, #qr-image canvas {
      border: 3px solid #eee; border-radius: 10px; padding: 6px; max-width: 220px;
    }

    .qr-badge {
      display: inline-block; margin-top: 8px; padding: 3px 10px;
      background: #f0f0f0; border-radius: 20px; font-size: 0.75em; color: #888;
    }

    .qr-expiry {
      margin-top: 10px; padding: 10px 14px; background: #f6f6f6;
      border-radius: 8px; font-size: 0.78em; color: #666; text-align: left;
    }

    .countdown-bar {
      text-align: center; font-size: 0.88em; color: #888;
      margin-bottom: 20px; padding: 10px;
      background: #fafafa; border-radius: 10px; border: 1px solid #eee;
    }

    .countdown-bar .time {
      font-size: 1.4em; font-weight: bold; color: #e74c3c; letter-spacing: 2px;
    }

    .warning-banner {
      margin-bottom: 18px; padding: 12px 14px;
      background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px;
      font-size: 0.82em; color: #856404; line-height: 1.6; display: none;
    }

    .expired-wrap { text-align: center; }
    .expired-wrap .icon { font-size: 3em; margin-bottom: 14px; color: #e74c3c; }
    .expired-wrap h1 { color: #e74c3c; }
    .expired-wrap p { color: #666; margin-top: 10px; font-size: 0.9em; line-height: 1.7; }

    .view { display: none; }
    .view.active { display: block; }
  </style>
</head>
<body>

<div class="card" id="card">

  <!-- ç®¡ç†è€…ãƒ“ãƒ¥ãƒ¼ -->
  <div id="admin-view" class="view">
    <h1>ğŸ“ QRã‚³ãƒ¼ãƒ‰è¨­å®š</h1>

    <div class="warning-banner" id="file-warning">
      âš ï¸ <strong>ã“ã®ã¾ã¾ã§ã¯ã‚¹ãƒãƒ›ã‹ã‚‰QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚</strong><br>
      <code>start_server.bat</code> ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã‹ã‚‰
      è¡¨ç¤ºã•ã‚ŒãŸURLã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="form-group">
      <label>æœ‰åŠ¹æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
      <input type="number" id="minutes-input" min="1" max="1440" value="30">
      <div class="hint">QRã‚³ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªæ™‚é–“ï¼ˆåˆ†ï¼‰</div>
    </div>

    <div class="form-group">
      <label>èƒŒæ™¯ç”»åƒURLï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="bg-url-input" placeholder="https://example.com/photo.jpg">
      <div class="hint">æœªå…¥åŠ›ã®å ´åˆã¯æ¡œè‰²ã®èƒŒæ™¯ã«ãªã‚Šã¾ã™</div>
    </div>

    <button class="btn" onclick="startQR()">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

    <div id="qr-section">
      <div id="qr-image"></div>
      <div class="qr-badge">ğŸ”„ æ¯ç§’è‡ªå‹•æ›´æ–°ä¸­</div>
      <div class="qr-expiry">
        <strong>æœ‰åŠ¹æœŸé™ï¼š</strong><span id="qr-expiry-text">â€”</span>
      </div>
    </div>
  </div>

  <!-- ç™»éŒ²ãƒ“ãƒ¥ãƒ¼ -->
  <div id="register-view" class="view">
    <h1>âœï¸ ãŠåå‰ã‚’å…¥åŠ›</h1>

    <div class="countdown-bar">
      æœ‰åŠ¹æœŸé™ã¾ã§<br>
      <span class="time" id="countdown-display">--:--</span>
    </div>

    <div class="form-group">
      <label>ãŠåå‰</label>
      <input type="text" id="name-input"
             placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
             maxlength="30"
             autocomplete="off"
             autocorrect="off"
             autocapitalize="off"
             spellcheck="false">
    </div>

    <button class="btn" id="submit-btn" onclick="submitName()">ç™»éŒ²ã™ã‚‹</button>
  </div>

  <!-- æœŸé™åˆ‡ã‚Œãƒ“ãƒ¥ãƒ¼ -->
  <div id="expired-view" class="view">
    <div class="expired-wrap">
      <div class="icon">â°</div>
      <h1>æœŸé™åˆ‡ã‚Œ</h1>
      <p>ã“ã®QRã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚<br>æ–°ã—ã„QRã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã—ã¦ãã ã•ã„ã€‚</p>
    </div>
  </div>

</div>

<script>
/* â”€â”€â”€ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ â”€â”€â”€ */
var params  = new URLSearchParams(window.location.search);
var mode    = params.get('mode')    || '';
var expires = parseInt(params.get('expires') || '0', 10);
var bgParam = params.get('bg')      || '';

/* â”€â”€â”€ åˆæœŸåŒ– â”€â”€â”€ */
if (mode === 'register') {
  if (expires && Date.now() > expires) {
    showView('expired-view');
  } else {
    showView('register-view');
    if (expires) startCountdown(expires);
  }
} else {
  showView('admin-view');
  if (location.protocol === 'file:') {
    document.getElementById('file-warning').style.display = 'block';
  }
}

/* â”€â”€â”€ ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ â”€â”€â”€ */
function showView(id) {
  ['admin-view', 'register-view', 'expired-view'].forEach(function(v) {
    document.getElementById(v).classList.remove('active');
  });
  document.getElementById(id).classList.add('active');
}

/* â”€â”€â”€ QRã‚³ãƒ¼ãƒ‰æ¯ç§’è‡ªå‹•ç”Ÿæˆ â”€â”€â”€ */
var qrTimer = null;
var qrObj   = null;

function startQR() {
  var min = parseInt(document.getElementById('minutes-input').value, 10);
  if (!min || min < 1) { alert('æœ‰åŠ¹æ™‚é–“ã‚’1åˆ†ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  qrObj = null;
  document.getElementById('qr-image').innerHTML = '';
  if (qrTimer) clearInterval(qrTimer);

  generateQRTick();
  qrTimer = setInterval(generateQRTick, 1000);
}

function generateQRTick() {
  var min = parseInt(document.getElementById('minutes-input').value, 10);
  if (!min || min < 1) return;

  var bg     = document.getElementById('bg-url-input').value.trim();
  var expiry = Date.now() + min * 60 * 1000;
  var base   = window.location.href.split('?')[0];
  var url    = base + '?mode=register&expires=' + expiry;
  if (bg) url += '&bg=' + encodeURIComponent(bg);

  var imgEl = document.getElementById('qr-image');

  if (!qrObj) {
    imgEl.innerHTML = '';
    try {
      qrObj = new QRCode(imgEl, {
        text: url,
        width: 220,
        height: 220,
        colorDark:  '#222222',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
      });
      document.getElementById('qr-section').style.display = 'block';
    } catch(e) {
      imgEl.innerHTML = '<p style="color:red;">QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + e.message + '</p>';
    }
  } else {
    try { qrObj.makeCode(url); } catch(e) {}
  }

  document.getElementById('qr-expiry-text').textContent =
    new Date(expiry).toLocaleString('ja-JP');
}

/* â”€â”€â”€ ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ â”€â”€â”€ */
var countdownTimer = null;

function startCountdown(expiryMs) {
  function tick() {
    var diff = expiryMs - Date.now();
    if (diff <= 0) {
      clearInterval(countdownTimer);
      showView('expired-view');
      return;
    }
    var s  = Math.floor(diff / 1000);
    var hh = Math.floor(s / 3600);
    var mm = Math.floor((s % 3600) / 60);
    var ss = s % 60;
    var disp = hh > 0
      ? hh + ':' + pad(mm) + ':' + pad(ss)
      : pad(mm) + ':' + pad(ss);
    document.getElementById('countdown-display').textContent = disp;
  }
  function pad(n) { return String(n).padStart(2, '0'); }
  tick();
  countdownTimer = setInterval(tick, 1000);
}

/* â”€â”€â”€ åå‰ç™»éŒ² â†’ ãŠç¥ã„ç”»é¢ã‚’ãã®å ´ã§æ§‹ç¯‰ â”€â”€â”€ */
function submitName() {
  var btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.textContent = 'å‡¦ç†ä¸­...';

  var name = document.getElementById('name-input').value.trim();
  if (!name) {
    alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    btn.disabled = false;
    btn.textContent = 'ç™»éŒ²ã™ã‚‹';
    return;
  }

  if (expires && Date.now() > expires) {
    if (countdownTimer) clearInterval(countdownTimer);
    showView('expired-view');
    return;
  }

  if (countdownTimer) clearInterval(countdownTimer);

  buildCongratsScreen(name);
}

function buildCongratsScreen(name) {
  var now = new Date();
  var dateStr = now.toLocaleDateString('ja-JP', {
    year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
  });

  /* èƒŒæ™¯ã‚¹ã‚¿ã‚¤ãƒ« */
  var bgStyle = bgParam
    ? 'background:url(' + bgParam + ') center/cover no-repeat;'
    : 'background:linear-gradient(160deg,#ffd6e0 0%,#ffb3c6 45%,#ff8fab 100%);';

  /* ç”»é¢å…¨ä½“ã‚’è¦†ã†ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ */
  var screen = document.createElement('div');
  screen.style.cssText = [
    'position:fixed',
    'top:0','left:0','right:0','bottom:0',
    'display:flex',
    'flex-direction:column',
    'align-items:center',
    'justify-content:space-around',
    'padding:60px 28px',
    'color:#fff',
    'text-align:center',
    'z-index:9999',
    bgStyle
  ].join(';');

  /* èƒŒæ™¯ç”»åƒãŒã‚ã‚‹å ´åˆã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  if (bgParam) {
    var overlay = document.createElement('div');
    overlay.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.38);';
    screen.appendChild(overlay);
  }

  /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  var inner = document.createElement('div');
  inner.style.cssText = 'position:relative;z-index:1;width:100%;display:flex;flex-direction:column;align-items:center;gap:48px;';

  /* ä¸Šæ®µï¼šå¹´æœˆæ—¥ */
  var dateEl = document.createElement('div');
  dateEl.style.cssText = 'font-size:clamp(1.1em,4vw,1.7em);font-weight:500;line-height:1.7;text-shadow:0 2px 12px rgba(0,0,0,0.55);';
  dateEl.textContent = dateStr;

  /* ä¸­æ®µï¼šåå‰ */
  var nameBlock = document.createElement('div');
  nameBlock.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:10px;';

  var nameLabel = document.createElement('div');
  nameLabel.style.cssText = 'font-size:clamp(0.85em,3.5vw,1.05em);opacity:0.9;letter-spacing:0.15em;';
  nameLabel.textContent = 'å’æ¥­ç”Ÿ';

  var nameEl = document.createElement('div');
  nameEl.style.cssText = 'font-size:clamp(2.8em,11vw,4.5em);font-weight:bold;letter-spacing:0.1em;text-shadow:0 4px 20px rgba(0,0,0,0.55);';
  nameEl.textContent = name;

  nameBlock.appendChild(nameLabel);
  nameBlock.appendChild(nameEl);

  /* ä¸‹æ®µï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
  var msgEl = document.createElement('div');
  msgEl.style.cssText = 'font-size:clamp(1.3em,5.5vw,2em);font-weight:bold;line-height:1.7;letter-spacing:0.05em;text-shadow:0 2px 12px rgba(0,0,0,0.55);';
  msgEl.textContent = 'ğŸ“ ã”å’æ¥­ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ ğŸ“';

  inner.appendChild(dateEl);
  inner.appendChild(nameBlock);
  inner.appendChild(msgEl);
  screen.appendChild(inner);

  /* body ã«è¿½åŠ ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’éš ã™ */
  document.body.appendChild(screen);
  document.getElementById('card').style.display = 'none';
}

/* â”€â”€â”€ Enter ã‚­ãƒ¼ã§ç™»éŒ² â”€â”€â”€ */
document.getElementById('name-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitName();
});
</script>
</body>
</html>
